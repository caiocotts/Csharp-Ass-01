@model List<TicketDataViewModel>

<!DOCTYPE html>

<html>
<head>
    <title>myTickets</title>
</head>

<body>
<h1 class="text-center">Tickets</h1>
@if (Model.Count > 0)
{
    <table class="table">
        <thead>
        <tr>
            <th>Purchase Date</th>
            <th>Event Title</th>
            <th>Event Date</th>
            <th>Quantity</th>
            <th>Total Cost</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var ticket in Model)
        {
            <tr>
                <td>@ticket.PurchaseDate.ToShortDateString()</td>
                <td>@ticket.EventTitle</td>
                <td>@ticket.EventDate.ToShortDateString()</td>
                <td>@ticket.Quantity</td>
                <td>@ticket.TotalCost</td>
                <td>
                    @*<a asp-action="downloadPDF" asp-route-id="@ticket.PurchaseID" class="btn btn-sm btn-warning me-2">
                            download PDF
                        </a>*@ @*TODO  do dis later*@

                    <button type="button"
                            class="btn btn-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#qrModal"
                            data-qr-id="@ticket.PurchaseId">
                        view QR code
                    </button>
                </td>
            </tr>
        }
        </tbody>
    </table>
}
else
{
    <p>You have no tickets.</p>
}

<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrModalLabel">Your Ticket QR</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalQrImage" src="" alt="Loading QR..." class="img-fluid"
                     style="width: 250px; height: 250px;"/>
                <p class="mt-3 text-muted">Scan this code at the event entrance.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const qrModal = document.getElementById('qrModal');

        qrModal.addEventListener('show.bs.modal', function (event) {
            // 1. Find the button that triggered the modal
            const button = event.relatedTarget;

            // 2. Extract the ID from the data-qr-id attribute
            const purchaseId = button.getAttribute('data-qr-id');

            // 3. Update the Image Source
            // This calls your DashboardController -> GenerateQr(int id)
            const modalImage = qrModal.querySelector('#modalQrImage');
            modalImage.src = '/Dashboard/GenerateQr?id=' + purchaseId;
        });

        // Optional: Clear image on close so the next one doesn't show the old one briefly
        qrModal.addEventListener('hidden.bs.modal', function () {
            const modalImage = qrModal.querySelector('#modalQrImage');
            modalImage.src = '';
        });
    });
</script>
</body>

</html>