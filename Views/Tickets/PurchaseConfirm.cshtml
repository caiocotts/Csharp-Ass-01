@using System.Globalization
@model PurchaseConfirmationViewModel
<link rel="stylesheet" href="/css/DarkMode.css">

@{
    ViewData["Title"] = "Purchase Tickets";
}

<h2>@ViewData["Title"]</h2>
<div>
    <hr/>
    @if (TempData["TicketAlert"] is string alertMessage)
    {
        var alertClass = string.Equals(TempData["TicketAlertType"] as string, "error", StringComparison.OrdinalIgnoreCase)
            ? "alert-danger"
            : "alert-success";
        <div class="alert @alertClass" role="alert">@alertMessage</div>
    }
    <dl class="row">
        <dt class="col-sm-3">Event</dt>
        <dd class="col-sm-9">@Model.EventTitle</dd>
        <dt class="col-sm-3">Category</dt>
        <dd class="col-sm-9">@Model.Category</dd>
        <dt class="col-sm-3">Event Date</dt>
        <dd class="col-sm-9">@Model.EventDate.ToString("f")</dd>
        <dt class="col-sm-3">Price per Ticket</dt>
        <dd class="col-sm-9">$@Model.PricePerTicket</dd>
        <dt class="col-sm-3">Purchasing As</dt>
        <dd class="col-sm-9">@Model.UserDisplayName</dd>
    </dl>

    @if (!Model.CanPurchase)
    {
        <div class="alert alert-warning" role="alert">
            This event is currently sold out.
        </div>
        <a asp-action="TicketPurchasing" class="btn btn-secondary">Back to Events</a>
    }
    else
    {
        <form asp-action="AddPurchase" method="post" class="mt-3">
            @Html.AntiForgeryToken()
            <input type="hidden" name="eventId" value="@Model.EventId" />
            <div class="mb-3">
                <label class="form-label" for="quantity">Quantity (max @Model.AvailableTickets)</label>
                <div class="input-group quantity-controls">
                    <button type="button" class="btn btn-outline-secondary" data-adjust="-1">-</button>
                    <input type="number"
                           id="quantity"
                           name="quantity"
                           class="form-control text-center"
                           value="@Model.DefaultQuantity"
                           min="1"
                           max="@Model.AvailableTickets"
                           readonly />
                    <button type="button" class="btn btn-outline-secondary" data-adjust="1">+</button>
                </div>
            </div>
            <p id="price" class="fw-bold">Total Price: $@Model.PricePerTicket</p>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Submit Order</button>
                <a asp-action="TicketPurchasing" class="btn btn-secondary">Back to Events</a>
            </div>
        </form>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const quantityInput = document.getElementById('quantity');
            if (!quantityInput) {
                return;
            }

            const priceDisplay = document.getElementById('price');
            const pricePerTicket = @Model.PricePerTicket.ToString("F2", CultureInfo.InvariantCulture);

            const updatePrice = () => {
                const quantity = parseInt(quantityInput.value, 10);
                const total = (quantity * pricePerTicket).toFixed(2);
                priceDisplay.textContent = `Total Price: $${total}`;
            };

            document.querySelectorAll('[data-adjust]').forEach(button => {
                button.addEventListener('click', () => {
                    const delta = parseInt(button.getAttribute('data-adjust'), 10);
                    const min = parseInt(quantityInput.min, 10);
                    const max = parseInt(quantityInput.max, 10);
                    const nextValue = parseInt(quantityInput.value, 10) + delta;

                    if (nextValue >= min && nextValue <= max) {
                        quantityInput.value = nextValue;
                        updatePrice();
                    }
                });
            });

            updatePrice();
        });
    </script>
}